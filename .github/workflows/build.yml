# Android Build Pipeline
# Equivalent to azure-pipelines.yml

name: Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Android App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'


      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/keystore.jks
          echo "Keystore file created"

      - name: Validate Keystore
        run: |
          if [ ! -f "app/keystore.jks" ]; then
            echo "Keystore file not found"
            exit 1
          fi
          echo "Keystore file found!"

      - name: Create Google Services JSON
        env:
          GOOGLE_SERVICES_DEBUG: ${{ secrets.GOOGLE_SERVICES_JSON_DEBUG }}
          GOOGLE_SERVICES_RELEASE: ${{ secrets.GOOGLE_SERVICES_JSON_RELEASE }}
        run: |
          # Create for both variants with separate configs
          mkdir -p app/src/debug app/src/release
          printf '%s' "$GOOGLE_SERVICES_DEBUG" > app/src/debug/google-services.json
          printf '%s' "$GOOGLE_SERVICES_RELEASE" > app/src/release/google-services.json
          
          if [ ! -f "app/src/debug/google-services.json" ] || [ ! -f "app/src/release/google-services.json" ]; then
            echo "ERROR: google-services.json files were not created"
            exit 1
          fi
          echo "Google Services JSON files created successfully"

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Calculate week number
        id: week
        run: echo "number=$(date +%V)" >> $GITHUB_OUTPUT

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-week-${{ steps.week.outputs.number }}-${{ hashFiles('gradle/libs.versions.toml') }}
          restore-keys: |
            gradle-${{ runner.os }}-
            gradle-

      - name: Calculate Version Code
        id: version
        run: |
          # Guaranteed monotonic version code: BASE_OFFSET + (run_number * 10) + attempt
          # Base offset ensures version > existing Play Store version (2854)
          # VERSION_CODE_OFFSET must be set as a repository variable
          if [ -z "$VERSION_CODE_OFFSET" ]; then
            echo "ERROR: VERSION_CODE_OFFSET variable is required but not set"
            echo "Set it at: Settings → Secrets and variables → Actions → Variables"
            exit 1
          fi
          VERSION_CODE=$(( VERSION_CODE_OFFSET + ${{ github.run_number }} * 10 + ${{ github.run_attempt }} ))
          echo "code=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "Calculated VERSION_CODE: ${VERSION_CODE} (Base: ${VERSION_CODE_OFFSET}, Run: ${{ github.run_number }}, Attempt: ${{ github.run_attempt }})"
        env:
          VERSION_CODE_OFFSET: ${{ vars.VERSION_CODE_OFFSET }}

      - name: Build Release Bundle and Run Tests
        run: ./gradlew bundleRelease test
        env:
          VERSION_CODE: ${{ steps.version.outputs.code }}
          KEYSTORE_FILE: ${{ github.workspace }}/app/keystore.jks
          KEYSTORE_ALIAS: ${{ secrets.KEYSTORE_ALIAS }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          ENCRYPTION_PASSPHRASE: ${{ secrets.ENCRYPTION_PASSPHRASE }}

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: '**/build/test-results/**/*.xml'

      - name: Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle
          path: app/build/outputs/bundle/release/*.aab
          retention-days: 30
